<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Telegram TV</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #000;
      color: #fff;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
    }
    #app {
      width: 90vw;
      aspect-ratio: 16 / 9;
      max-width: 1920px;
      max-height: 1080px;
      background: #111;
      border: 4px solid #444;
      border-radius: 20px;
      overflow: hidden;
    }
    .screen {
      display: none;
      padding: 30px;
    }
    .screen.active {
      display: block;
    }
    input, button {
      display: block;
      width: 300px;
      height: 60px;
      font-size: 28px;
      margin: 10px 0;
      padding: 10px;
      border-radius: 10px;
      border: 2px solid #444;
      background: #222;
      color: #fff;
    }
    button:focus {
      outline: 4px solid #00aaff;
      outline-offset: 2px;
    }
    #channels-list {
      list-style: none;
      padding: 0;
      margin: 30px 0;
    }
    #channels-list li {
      padding: 20px;
      margin: 10px 0;
      background: #222;
      border: 2px solid #333;
      border-radius: 10px;
      font-size: 24px;
      cursor: pointer;
    }
    #channels-list li:focus {
      border-color: #00aaff;
      background: #003355;
      outline: none;
    }
    #videos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .video-item {
      background: #222;
      border: 2px solid #333;
      border-radius: 12px;
      padding: 15px;
      cursor: pointer;
      text-align: center;
    }
    .video-item:focus {
      border-color: #00aaff;
      background: #003355;
      outline: none;
    }
    .video-thumb {
      width: 100%;
      height: 180px;
      background: #000;
      border-radius: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 80px;
      color: #aaa;
    }
    .video-title {
      margin-top: 10px;
      font-size: 20px;
      color: #ccc;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #player-container {
      width: 100%;
      height: 100%;
      background: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #video-player {
      width: 95%;
      height: 85%;
      margin-bottom: 10px;
    }
    .player-button {
      align-self: flex-start;
      margin-left: 5%;
    }
  </style>
  <script>
    // === LRUD (Spatial Navigation) ===
    // Adapté pour TV, navigation flèches/télécommande
    (function() {
      class LRUD {
        constructor() {
          this.nodes = {};
          this.focus = null;
        }
        registerNode(id, options) {
          this.nodes[id] = options;
          if (!this.focus) this.focus = id;
        }
        handleKeyEvent(e) {
          if (!this.focus) return;
          const node = this.nodes[this.focus];
          if (node && node.isFocusable) {
            const list = document.querySelectorAll(`[data-focus="${this.focus}"]`);
            if (list.length) list[0].focus();
          }
        }
      }
      window.LRUD = { Lrud: LRUD };
    })();
  </script>
  <script>
    // === gram.js (MTProto pour navigateur) ===
    // Ce code est un extrait minimal de gram.js (UMD) pour le navigateur
    // Pour une version complète, télécharger gramjs.umd.min.js depuis https://cdn.jsdelivr.net/npm/gramjs
    // Ici, on fournit un squelette pour l’initialisation
    (function() {
      window.Telegram = {
        StringSession: function(s) { return { save: () => {}, load: () => {} }; },
        TelegramClient: function(session, apiId, apiHash, options) {
          return {
            signInUserWithPhoneNumber: async (apiId, apiHash, { phone }) => {
              return { phone };
            },
            signInUserWithPhoneNumber: async (code) => {
              return { phoneCode: code };
            },
            getDialogs: async (options) => {
              return [
                { id: 1, title: 'Canal 1', isChannel: true },
                { id: 2, title: 'Canal 2', isChannel: true }
              ];
            },
            getMessages: async (channel, options) => {
              return [
                { id: 1, media: { document: { url: 'https://example.com/video1.mp4' } } },
                { id: 2, media: { document: { url: 'https://example.com/video2.mp4' } } }
              ];
            }
          };
        }
      };
    })();
  </script>
</head>
<body>
  <div id="app">
    <div id="login-screen" class="screen active">
      <h1>Connexion Telegram</h1>
      <label>
        API ID: <input type="text" id="api-id" placeholder="12345678">
      </label>
      <label>
        API HASH: <input type="text" id="api-hash" placeholder="a1b2c3d4...">
      </label>
      <button id="login-step1">Se connecter</button>
      <div id="login-code" style="display:none; margin-top: 20px">
        <label>
          Code SMS: <input type="text" id="phone-code" placeholder="12345">
        </label>
        <button id="login-step2">Valider code</button>
      </div>
    </div>
    <div id="channels-screen" class="screen">
      <h1>Sélectionnez un canal</h1>
      <ul id="channels-list"></ul>
    </div>
    <div id="videos-screen" class="screen">
      <h1>Vidéos du canal</h1>
      <div id="videos-grid"></div>
    </div>
    <div id="player-screen" class="screen">
      <div id="player-container">
        <video id="video-player" controls></video>
        <button id="player-back" class="player-button">← Retour</button>
      </div>
    </div>
  </div>

  <script>
    // === Logique principale ===
    let client = null;
    let channels = [];
    let currentChannel = null;
    let videoItems = [];
    const navigator = new LRUD.Lrud();

    const loginScreen = document.getElementById('login-screen');
    const channelsScreen = document.getElementById('channels-screen');
    const videosScreen = document.getElementById('videos-screen');
    const playerScreen = document.getElementById('player-screen');

    navigator.registerNode('root', { orientation: 'vertical' });
    navigator.registerNode('login', { parent: 'root', isFocusable: true });
    navigator.registerNode('channels', { parent: 'root', isFocusable: true });
    navigator.registerNode('videos', { parent: 'root', isFocusable: true });
    navigator.registerNode('player', { parent: 'root', isFocusable: true });
    navigator.assignFocus('login');

    document.addEventListener('keydown', (e) => {
      navigator.handleKeyEvent(e);
    });

    function showScreen(screen) {
      document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
      screen.classList.add('active');
    }

    document.getElementById('login-step1').addEventListener('click', async () => {
      const apiId = parseInt(document.getElementById('api-id').value.trim());
      const apiHash = document.getElementById('api-hash').value.trim();
      if (!apiId || !apiHash) {
        alert('Veuillez saisir API ID et API HASH');
        return;
      }
      try {
        const session = new Telegram.StringSession('');
        client = new Telegram.TelegramClient(session, apiId, apiHash, { connectionRetries: 5 });
        await client.signInUserWithPhoneNumber(apiId, apiHash, { phone: '+33123456789' });
        document.getElementById('login-code').style.display = 'block';
        document.getElementById('login-step1').disabled = true;
      } catch (err) {
        alert(`Erreur: ${err.message}`);
      }
    });

    document.getElementById('login-step2').addEventListener('click', async () => {
      const code = document.getElementById('phone-code').value.trim();
      if (!code) {
        alert('Code requis');
        return;
      }
      try {
        await client.signInUserWithPhoneNumber(code);
        alert('Connecté avec succès !');
        await loadChannels();
        showScreen(channelsScreen);
      } catch (err) {
        alert(`Code incorrect : ${err.message}`);
      }
    });

    async function loadChannels() {
      try {
        const dialogs = await client.getDialogs({ limit: 100 });
        channels = dialogs.filter(d => d.isChannel);
        const channelsList = document.getElementById('channels-list');
        channelsList.innerHTML = '';
        channels.forEach((ch, idx) => {
          const li = document.createElement('li');
          li.setAttribute('data-focus', 'channels-' + idx);
          li.textContent = ch.title || ch.username || 'Canal';
          li.dataset.channelId = ch.id;
          li.addEventListener('click', () => selectChannel(ch));
          channelsList.appendChild(li);
          navigator.registerNode('channels-' + idx, { parent: 'root', isFocusable: true });
        });
      } catch (err) {
        alert(`Erreur chargement canaux: ${err.message}`);
      }
    }

    function selectChannel(channel) {
      currentChannel = channel;
      loadVideos(channel);
      showScreen(videosScreen);
    }

    async function loadVideos(channel) {
      try {
        const messages = await client.getMessages(channel, { limit: 50, filter: Telegram.Filter('video') });
        videoItems = messages.map(m => ({
          id: m.id,
          filename: m.media.document.attributes?.find(a => a.className === 'DocumentAttributeFilename')?.fileName || 'vidéo',
          size: m.media.document.size,
          mime: m.media.document.mimeType,
          url: m.media.document.url
        }));
        const grid = document.getElementById('videos-grid');
        grid.innerHTML = '';
        videoItems.forEach((vid, idx) => {
          const item = document.createElement('div');
          item.className = 'video-item';
          item.setAttribute('data-focus', 'video-' + idx);
          item.innerHTML = `<div class="video-thumb">▶</div><div class="video-title">${vid.filename}</div>`;
          item.addEventListener('click', () => playVideo(vid));
          grid.appendChild(item);
          navigator.registerNode('video-' + idx, { parent: 'root', isFocusable: true });
        });
      } catch (err) {
        alert(`Erreur chargement vidéos: ${err.message}`);
      }
    }

    function playVideo(video) {
      const videoPlayer = document.getElementById('video-player');
      videoPlayer.src = video.url;
      videoPlayer.addEventListener('loadedmetadata', () => videoPlayer.play());
      showScreen(playerScreen);
      const container = document.getElementById('player-container');
      if (container.requestFullscreen) container.requestFullscreen();
      else if (container.webkitRequestFullscreen) container.webkitRequestFullscreen();
      else if (container.mozRequestFullScreen) container.mozRequestFullScreen();
      else if (container.msRequestFullscreen) container.msRequestFullscreen();
    }

    document.getElementById('player-back').addEventListener('click', () => {
      const videoPlayer = document.getElementById('video-player');
      videoPlayer.pause();
      videoPlayer.src = '';
      if (document.exitFullscreen) document.exitFullscreen();
      else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
      else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
      else if (document.msExitFullscreen) document.msExitFullscreen();
      showScreen(videosScreen);
    });
  </script>
</body>
</html>
